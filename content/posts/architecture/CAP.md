+++
date = '2025-07-16T09:21:40+08:00'
draft = false
title = 'CAP'
[cover]
image = "/images/cap.png"  # 路径基于 /static/
relative = true
+++
### 定义
CAP理论是指分布式当中一致性、可用性以及分区容错性三者不可兼得。我们需要根据实际应用场景做出相应的取舍，
在现实中，一般来说分布式系统中的网络是不可能完全保证可用的，所以就需要在CP和AP中做出选择。
#### 拜占庭将军问题
是指分布式系统中可能有恶意节点对数据一致性造成破坏。如果系统中的节点是f个，为了解决非拜占庭将军问题，至少需要3f+1
个节点。能容忍拜占庭容错的系统一般是高安全性要求的系统，比如区跨链、金融、军事等。
#### 脑裂
脑裂是指分布式系统中由于网络波动或中断，导致系统被分成多个子系统，子系统在内部选举leader，对外提供服务。这会导致
严重的问题，比如
* 数据不一致	两个分区同时写入同一数据（如账户余额），导致冲突且无法自动合并。
* 资源冲突	两个“领导者”同时操作共享资源（如分配同一IP地址、锁定同一文件）。
* 状态混乱	客户端可能被不同分区响应矛盾的结果（如A分区说“支付成功”，B分区说“未支付”）。
* 数据永久丢失	分区恢复后，冲突写入可能导致部分数据被覆盖或丢弃。

为了防止脑裂，一般分布式一致性协议都会采用多数派原则进行避免，比如五个节点的分布式系统中，需要3个节点的确认才能成为leader,否则会
因为无法选主而停止对外提供服务。
#### raft协议
raft协议是分布式系统中多个节点对于某个资源的一致性的达成所采用的一种协议，主要有三个部分：
1. 主从选择
2. 日志复制
3. 安全性和一致性保证
raft协议是强一致的。还有一些其他的一致性组件比如zookeeper。
#### zookeeper

### 实践
#### 常见的使用场景
一些常见的开源软件的使用我们会经常遇到这个场景。拿最常见的redis为例，redis的分布式部署方案有三种，主从、哨兵、cluster。
### 注意事项
1. 这个理论提醒我们在分布式系统中需要根据具体的需求做出取舍。
2. raft协议的只保证写强一致，对于读默认是从leader读就没问题，如果从follower可能会不一致。需要注意
3. raft协议是在非拜占庭情况下为了达成一致性的一种协议，需要注意这点。
#### redis分布式锁在分布式部署情况下的问题
简单来说需要把所有锁操作限定到一个槽里面，其次可以使用开源的解决方案比如redLock,以及优秀的redis客户端在发生key在其他节点会自动帮助我们
处理move操作
### 参考资料
1. **维基百科编者**. [CAP定理](https://zh.wikipedia.org/wiki/CAP定理). *维基百科*. 最后修订于2023年11月9日. 访问于2025年7月16日.
1. **CNBLOG**. [ZooKeeper 是什么](https://www.cnblogs.com/jiusibuiu/p/14210257.html). *维基百科*. 最后修订于2020-12-30 10:53. 访问于2025年7月20日.

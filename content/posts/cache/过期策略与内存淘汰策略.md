+++
date = '2025-09-02T10:17:27+08:00'
draft = false
title = '过期策略与内存淘汰策略'
+++

---

## 一、Redis 的键过期机制

Redis 可以对每个 key 设置一个 **过期时间（TTL, Time To Live）**，过期后 key 会被删除。

### 1. 过期策略

Redis 对 key 的过期有两种策略：

#### (1) 惰性删除（Lazy Expiration）

* **原理**：只有当 key 被访问时，Redis 才检查它是否过期。
* **优点**：避免了不必要的 CPU 消耗。
* **缺点**：过期 key 如果长时间不访问，会占用内存。

#### (2) 定期删除（Periodic Expiration）

* **原理**：Redis 会周期性（默认每 100ms）随机检查一些带过期时间的 key，并删除过期 key。
* **实现**：

    1. 每次检查 20 个 key。
    2. 如果过期数量 > 25%，继续检查下一批 key。
    3. 每次检查耗时不超过 1ms。
* **优点**：可以及时回收内存。
* **缺点**：不能保证所有过期 key 立即删除，可能延迟。

> Redis 综合使用了惰性删除和定期删除，保证性能和及时性之间的平衡。

---

### 2. TTL 命令

* `EXPIRE key seconds` 设置过期时间。
* `EXPIREAT key timestamp` 按时间戳设置过期时间。
* `TTL key` 查看剩余时间。
* `PTTL key` 查看毫秒级 TTL。

---

## 二、Redis 的淘汰策略（内存不足时）

当 Redis 设置了 **maxmemory** 限制，并且内存达到上限时，需要 **淘汰旧数据**。

Redis 支持以下几种淘汰策略：

| 策略                  | 行为                       |
| ------------------- | ------------------------ |
| **noeviction**      | 不淘汰，直接返回错误（写命令失败）        |
| **allkeys-lru**     | 对所有 key 使用 LRU（最近最少使用）策略 |
| **volatile-lru**    | 对设置了过期时间的 key 使用 LRU     |
| **allkeys-random**  | 随机淘汰任意 key               |
| **volatile-random** | 随机淘汰有过期时间的 key           |
| **volatile-ttl**    | 优先淘汰 TTL 最短的 key         |

> 注意：
>
> * **allkeys** 表示从所有 key 中选择。
> * **volatile** 表示只从带过期时间的 key 中选择。

---

### 1. LRU 淘汰机制

* Redis 会维护一个 **近似 LRU** 数据结构。
* 实现上并不是对所有 key 完全排序，而是随机抽样（默认 5 个 key）选择最近最少使用的 key 淘汰。
* 时间复杂度：O(1)（近似 LRU）

### 2. LFU 淘汰机制（Redis 4.0+）

* LFU = Least Frequently Used，淘汰使用频率最低的 key。
* Redis 维护访问频率计数器，定期衰减。
* 策略：

    * **allkeys-lfu**：所有 key 使用 LFU。
    * **volatile-lfu**：仅对带 TTL 的 key 使用 LFU。

---

### 3. 随机淘汰

* 随机选择 key 淘汰，算法简单，但可能会淘汰热数据。
* 使用场景：不关心哪些数据更重要的情况。

---

### 4. TTL 淘汰

* 优先淘汰过期时间最短的 key。
* 用于对数据时效性敏感的场景。

---

## 三、Redis 内存回收总结

1. **过期删除**：

    * 惰性删除 + 定期删除
2. **内存淘汰**（maxmemory 达到限制）：

    * 配置 maxmemory-policy（如 allkeys-lru、volatile-lfu 等）
3. **关键点**：

    * Redis 不会每秒扫描所有 key。
    * 淘汰策略是 **近似算法**，兼顾性能和内存控制。
    * 对性能敏感的场景，可以使用 LRU/LFU。
    * 对过期时间敏感的场景，可以使用 TTL 策略。

---

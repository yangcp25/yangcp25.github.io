+++
date = '2025-10-22T09:58:12+08:00'
draft = false
title = 'Defer'
+++

## âœ… ä¸€ã€`defer` çš„åŸºæœ¬ä½œç”¨

> `defer` ç”¨æ¥**å»¶è¿Ÿæ‰§è¡Œ**ä¸€æ®µå‡½æ•°è°ƒç”¨ï¼Œç›´åˆ°**å½“å‰å‡½æ•°è¿”å›**æ—¶æ‰æ‰§è¡Œï¼ˆæ— è®ºæ˜¯æ­£å¸¸è¿”å›è¿˜æ˜¯é‡åˆ° panicï¼‰ã€‚

### ç¤ºä¾‹ï¼š

```go
func main() {
    fmt.Println("A")
    defer fmt.Println("B")
    fmt.Println("C")
}
```

è¾“å‡ºï¼š

```
A
C
B
```

ğŸ‘‰ `defer` çš„è°ƒç”¨ä¼šåœ¨å‡½æ•°é€€å‡ºæ—¶æ‰§è¡Œã€‚

---

## âœ… äºŒã€å¤šä¸ª `defer` çš„æ‰§è¡Œé¡ºåºï¼š**åè¿›å…ˆå‡º (LIFO)**

```go
func main() {
    defer fmt.Println("1")
    defer fmt.Println("2")
    defer fmt.Println("3")
}
```

è¾“å‡ºï¼š

```
3
2
1
```

> å°±åƒæ ˆä¸€æ ·ï¼Œæœ€åæ³¨å†Œçš„ `defer` æœ€å…ˆæ‰§è¡Œã€‚

---

## âœ… ä¸‰ã€å‚æ•°æ±‚å€¼æ—¶æœºï¼š**defer å®šä¹‰æ—¶å°±æ±‚å€¼**

è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç»†èŠ‚ï¼

```go
func main() {
    x := 10
    defer fmt.Println("defer:", x)
    x = 20
    fmt.Println("x =", x)
}
```

è¾“å‡ºï¼š

```
x = 20
defer: 10
```

ğŸ”¹ åŸå› ï¼š
`defer` çš„å‚æ•°ä¼šåœ¨**æ³¨å†Œ defer æ—¶**ç«‹åˆ»æ±‚å€¼ï¼Œè€Œä¸æ˜¯åœ¨æ‰§è¡Œæ—¶æ±‚å€¼ã€‚

---

## âœ… å››ã€é—­åŒ… deferï¼šå¼•ç”¨å¤–éƒ¨å˜é‡æ—¶ä¼šå®æ—¶è¯»å–

```go
func main() {
    x := 10
    defer func() {
        fmt.Println("defer:", x)
    }()
    x = 20
    fmt.Println("x =", x)
}
```

è¾“å‡ºï¼š

```
x = 20
defer: 20
```

ğŸ‘‰ å› ä¸ºè¿™é‡Œ `defer` å»¶è¿Ÿçš„æ˜¯**åŒ¿åå‡½æ•°**ï¼Œå®ƒæŒæœ‰ `x` çš„å¼•ç”¨ï¼ˆé—­åŒ…ï¼‰ï¼Œæ‰€ä»¥æ‰§è¡Œæ—¶è¯»åˆ°çš„æ˜¯æœ€æ–°å€¼ã€‚

---

## âœ… äº”ã€`defer` ä¸è¿”å›å€¼çš„å…³ç³»

### æƒ…å†µ1ï¼šå‘½åè¿”å›å€¼ï¼ˆå¯è¢«ä¿®æ”¹ï¼‰

```go
func demo() (x int) {
    defer func() {
        x++ // ä¿®æ”¹å‘½åè¿”å›å€¼
    }()
    return 1
}

func main() {
    fmt.Println(demo()) // è¾“å‡º 2
}
```

è§£é‡Šï¼š

* `return 1` ä¼šå…ˆç»™ `x = 1`
* ç„¶åæ‰§è¡Œ `defer`
* æœ€åè¿”å›ä¿®æ”¹åçš„ `x = 2`

---

### æƒ…å†µ2ï¼šéå‘½åè¿”å›å€¼ï¼ˆä¸ä¼šä¿®æ”¹ï¼‰

```go
func demo() int {
    x := 1
    defer func() {
        x++
    }()
    return x
}

func main() {
    fmt.Println(demo()) // è¾“å‡º 1
}
```

> è¿”å›å€¼ä¸æ˜¯å‘½åè¿”å›å€¼ï¼Œ`defer` é‡Œä¿®æ”¹ `x` ä¸å½±å“è¿”å›ã€‚

---

## âœ… å…­ã€`defer` å³ä½¿é‡åˆ° `panic` ä¹Ÿä¼šæ‰§è¡Œ

```go
func main() {
    defer fmt.Println("defer executed")
    panic("something went wrong")
}
```

è¾“å‡ºï¼š

```
defer executed
panic: something went wrong
```

---

## âœ… ä¸ƒã€`defer` å¸¸è§çš„ä½¿ç”¨åœºæ™¯

| åœºæ™¯       | ç¤ºä¾‹                                                                      |
| -------- | ----------------------------------------------------------------------- |
| æ–‡ä»¶å…³é—­     | `defer file.Close()`                                                    |
| æ•°æ®åº“è¿æ¥å…³é—­  | `defer db.Close()`                                                      |
| ç½‘ç»œè¿æ¥å…³é—­   | `defer conn.Close()`                                                    |
| é”é‡Šæ”¾      | `mu.Lock(); defer mu.Unlock()`                                          |
| panic æ¢å¤ | `defer func(){ if err := recover(); err != nil {...} }()`               |
| æ€§èƒ½ç»Ÿè®¡     | `start := time.Now(); defer func(){ fmt.Println(time.Since(start)) }()` |

---

## âš ï¸ å…«ã€æ€§èƒ½æ³¨æ„äº‹é¡¹

`defer` åœ¨ Go 1.14 ä¹‹åæ€§èƒ½å·²æ˜¾è‘—æå‡ï¼Œä½†ä»æœ‰ä¸€äº›æ³¨æ„ç‚¹ï¼š

| åœºæ™¯                    | å»ºè®®                  |
| --------------------- | ------------------- |
| é«˜é¢‘å¾ªç¯å†…è°ƒç”¨ `defer`       | âŒ å°½é‡é¿å…ï¼ˆå¯æ‰‹åŠ¨è°ƒç”¨ï¼‰       |
| æ™®é€šå‡½æ•°ä¸­ä½¿ç”¨ 1~3 ä¸ª `defer` | âœ… å®Œå…¨æ²¡é—®é¢˜             |
| Go 1.14+              | âœ… defer æ€§èƒ½å‡ ä¹ç­‰ä»·äºæ‰‹åŠ¨è°ƒç”¨ |

---

## âœ… ä¹ã€å‡½æ•°æ‰§è¡Œé¡ºåºæ€»ç»“ï¼ˆè¶…æ¸…ç‰ˆï¼‰

```go
func example() (result int) {
    defer fmt.Println("1")
    defer func() {
        fmt.Println("2, result =", result)
    }()
    defer func(r int) {
        fmt.Println("3, r =", r)
    }(result)
    result = 100
    return
}
```

è¾“å‡ºï¼š

```
3, r = 0
2, result = 100
1
```

**æ‰§è¡Œé€»è¾‘ï¼š**

1. `defer` å‚æ•°æ±‚å€¼é¡ºåºï¼šç«‹å³æ‰§è¡Œï¼ˆ`r = 0`ï¼‰
2. `return` æ‰§è¡Œï¼šèµ‹å€¼ `result = 100`
3. æŒ‰ LIFO é¡ºåºæ‰§è¡Œ `defer`
4. å‡½æ•°è¿”å›

---

## âœ… åã€æ€»ç»“

| ç‰¹æ€§        | è¯´æ˜                   |
| --------- | -------------------- |
| æ‰§è¡Œæ—¶æœº      | å‡½æ•°è¿”å›å‰æ‰§è¡Œï¼ˆæ­£å¸¸è¿”å›æˆ– panicï¼‰ |
| æ‰§è¡Œé¡ºåº      | åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰           |
| å‚æ•°æ±‚å€¼æ—¶æœº    | æ³¨å†Œæ—¶æ±‚å€¼                |
| æ”¯æŒé—­åŒ…      | å¯ä»¥è®¿é—®å¤–éƒ¨å˜é‡             |
| å‘½åè¿”å›å€¼å¯ä¿®æ”¹  | æ˜¯                    |
| panic ä»æ‰§è¡Œ | æ˜¯                    |
| æ€§èƒ½        | Go1.14+ å·²å¤§å¹…ä¼˜åŒ–        |

---


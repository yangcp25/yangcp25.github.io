+++
date = '2025-08-01T09:10:17+08:00'
title = '逃逸分析'
draft = false
tag = ['go', '逃逸分析']
+++
### 什么是逃逸分析
计算机科学中对指针作用范围进行分析就叫做逃逸分析。分析变量是分配到堆上还是栈上。
分配到堆上和栈上的对比
|      | 栈           | 堆                   |
|------|-------------|---------------------|
| 分配方式 | 随着函数创建自动分配  | 程序员手动分配             | 
| 资源消耗 | 很小  ，大小固定        | 比较大，大小不固定，需要寻找到合适的大小。容易产生内存碎片           |
| 回收方式 | 随着函数的结束进行销毁 | 需要手动回收,或者根据gc算法进行回收 |

所以说编译器会尽可能的将变量分配到栈上， go会在静态编译阶段就确定变量到底应该分配到堆上还是栈上。
当一个变量在函数之外的地方还会被使用就会发生逃逸。
#### 以下几个场景会发生逃逸
* 返回一个变量的指针
* 返回一个闭包函数，闭包函数捕获了调用函数的变量
* 往channel发送了变量的指针
* 巨大的变量，编译器为了防止栈内存不够，会将其分配到堆上
* 引用类型的使用，比如传递slice、map、chan、interface等
### 如何对go的程序进行逃逸分析
使用源码go build --gcflags '-m -l'分析，看变量是否发生了逃逸
还可以结合pprof对堆内存的分配进行查看，结合热点路径使用go gc flag 进行分析
```go

```
### 如何使用
### 逃逸分析需要注意的点
1. 在不影响代码结构合理性的情况下，进行减少使用指针（变量的内存占用不大的情况下）。
2. 不要过度设计，持续重构。也就是先实现业务，再去结合工具来进行调整